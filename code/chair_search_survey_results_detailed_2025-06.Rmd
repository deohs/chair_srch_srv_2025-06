---
title: "Chair Search Survey Detailed Results"
author: "DEOHS"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    keep_md: true
  html_document:
    keep_md: true
editor_options:
  chunk_output_type: console
---

```{r knitr_setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache.rebuild = TRUE, fig.height=2.5)
```

```{r package_setup}
# Load packages, installing as needed
if (!requireNamespace("pacman", quietly = TRUE)) install.packages('pacman')
pacman::p_load(here, folders, readxl, tibble, dplyr, tidyr, stringr, purrr, 
               ggplot2, colorspace, forcats, CGPfunctions)
```

```{r folder_setup}
# Get the list of standard folders and create any folders which are missing
conf_file <- here('conf', 'folders.yml')
folders <- get_folders(conf_file)
result <- create_folders(folders)
```

```{r functions}
show_counts <- function(df, x) {
  df %>% group_by({{x}}) %>% summarise(Count = n()) %>% 
    arrange(desc(Count), {{x}}) %>% knitr::kable()
}

show_bar_plot <- function(df, x, title = '') {
  N <- nrow(df)
  ylab_text <- paste0('Count (N=', N, ')')
  df %>% 
    ggplot(aes(fct_rev({{x}}))) + geom_bar() + coord_flip() + 
    geom_text(aes(label = after_stat(count)), stat = "count", hjust = 1.5, 
              color = 'white', size = 3) + 
    theme_minimal() + theme(axis.title.y = element_blank()) + 
    ylab(ylab_text) + ggtitle(label = title)
}

show_xtab_plot <- function(df, x, y, title.x = NULL, title.y = NULL) {
  title.x <- ifelse(!is.null(title.x), title.x, x)
  title.y <- ifelse(!is.null(title.y), title.y, y)
  df[[x]] <- fct_rev(factor(df[[x]])) 
  PlotXTabs2(df, any_of(x), any_of(y), ggtheme = theme_minimal(),
    legend.title = title.y, title = paste(title.x, 'by', title.y), xlab = '',
    legend.position = 'bottom') + coord_flip()
  # sample.size.label = FALSE, results.subtitle = FALSE,
}

show_bar_plot_identity <- function(df, x, y, title = '') {
  df %>% 
    ggplot(aes(fct_rev({{x}}), {{y}})) + geom_bar(stat = 'identity') + 
    coord_flip() +
    geom_text(aes(label = {{y}}), hjust = 1.5, color = 'white', size = 3) + 
      theme_minimal() + theme(axis.title.y = element_blank()) + 
      ggtitle(label = title)
}

show_comments <- function(x) {
  x %>% .[!is.na(.)] %>% knitr::kable(, col.names = 'Comments')
}

xform_ranking <- function(x) {
  x %>% str_remove(';$') %>% str_split('\\s*;\\s*') %>% 
    setNames('Candidate') %>% as_tibble() %>% 
    rowid_to_column(var = 'Rank') %>% 
    separate_longer_delim(Candidate, '=') %>% 
    mutate(Candidate = str_trim(Candidate))
}

rank_ties <- function(df, rankvar = 'Rank', valvar = 'Total', rows = 1:5) {
  df[[rankvar]][rows] <- 
    as.numeric(factor(rank(df[[valvar]][rows], ties.method='min')))
  df
}
```

```{r get_data}
fn <- 'DEOHS Faculty Feedback Survey_ Chair Search.xlsx'
txt_fn <- str_replace(fn, '\\.xlsx$', '.txt')
csv_fn <- str_replace(fn, '\\.xlsx$', '.csv')
fp <- here(folders$data, fn)
txt_fp <- here(folders$data, txt_fn)
csv_fp <- here(folders$data, csv_fn)

affect_level <- c("Strongly favor internal candidate", 
  "Slightly favor internal candidate", 
  "This does not affect my final preference for an internal or external candidate.", 
  "Slightly favor external candidate", 
  "Strongly favor external candidate")

affect_label <- c("Strongly favor internal candidate", 
  "Slightly favor internal candidate", 
  "Does not affect my final preference", 
  "Slightly favor external candidate", 
  "Strongly favor external candidate")

new_names <- c('id', 'start_time', 'end_time', 'mod_time', 
               'q01_myrank', 'q02_mytrack', 'q03_pref_int_ext', 
               'q04_affect_start', 'q05_affect_start_comment',
               'q06_affect_cost', 'q07_affect_cost_comment', 
               'q08_affect_funds', 'q09_affect_funds_comment',
               'q10_affect_freeze', 'q11_affect_freeze_comment', 
               'q12_ranking', 'q13_ranking_comment', 
               'q14_final_comments')

if (( ! file.exists(csv_fp) ) | 
    (file.exists(fp) & (file.mtime(fp) > file.mtime(csv_fp))) ) {
  df <- read_xlsx(fp) %>% 
    #filter(! Email %in% c('foo@uw.edu', 'bar@uw.edu')) %>%   # Remove tests
    select(-Email, -Name)
  old_names <- names(df) %>% str_remove_all('\\r\\n.*$')
  writeLines(old_names, txt_fp)
  old_names <- as.list(old_names)
  names(old_names) <- new_names
  names(df) <- new_names
  write.csv(df, csv_fp, row.names = FALSE)
} else {
  df <- read.csv(csv_fp, stringsAsFactors = FALSE)
  old_names <- as.list(readLines(txt_fp)) %>% .[. != ''] %>% .[1:18]
  names(old_names) <- new_names
}
df <- df %>% 
  mutate(across(matches('^q\\d+_affect_[a-z]+$'), 
           ~ factor(.x, levels = affect_level, labels = affect_label, 
                    ordered = TRUE)),
         across(matches('_comments?$'), 
           ~ ifelse(!is.na(.x), paste('â€¢', str_remove_all(.x, '[\n]+')), .x)))
```

## Section 1

### Q1: Rank

`r old_names$q01_myrank`

```{r q01_myrank}
show_counts(df, q01_myrank)
```

### Q2: Track

`r old_names$q02_mytrack`

```{r q02_mytrack}
show_counts(df, q02_mytrack)
```

### Q3: Preference (Internal, External, or None)

`r old_names$q03_pref_int_ext`

```{r q03_pref_int_ext_plot}
q03_levels <- c("Internal", "No preference", "External")
df$q03_pref_int_ext <- 
  factor(df$q03_pref_int_ext, levels = q03_levels, ordered = TRUE)
show_bar_plot(df, q03_pref_int_ext, 'q03_pref_int_ext')
```

\newpage

## Section 2

### Q4: Preference (affect factor: delayed start)

`r old_names$q04_affect_start`

```{r q04_affect_start_plot}
show_bar_plot(df, q04_affect_start, 'q04_affect_start')
```

<p>&nbsp;</p>

```{r q05_affect_start_comment}
show_comments(df$q05_affect_start_comment)
```

\newpage

```{r q04_affect_start_xtab_myrank_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q04_affect_start', 'q01_myrank', title.y = 'Respondent Rank')
```

<p>&nbsp;</p>

```{r q04_affect_start_xtab_mytrack_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q04_affect_start', 'q02_mytrack', title.y = 'Respondent Track')
```

\newpage

### Q6: Preference (affect factor: additional cost)

`r old_names$q06_affect_cost`

```{r q06_affect_cost_plot}
show_bar_plot(df, q06_affect_cost, 'q06_affect_cost')
```

<p>&nbsp;</p>

```{r q07_affect_cost_comment}
show_comments(df$q07_affect_cost_comment)
```

\newpage

```{r q06_affect_cost_xtab_myrank_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q06_affect_cost', 'q01_myrank', title.y = 'Respondent Rank')
```

<p>&nbsp;</p>

```{r q06_affect_cost_xtab_mytrack_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q06_affect_cost', 'q02_mytrack', title.y = 'Respondent Track')
```

\newpage

### Q8: Preference (affect factor: availability of funds)

`r old_names$q08_affect_funds`

```{r q08_affect_funds_plot}
show_bar_plot(df, q08_affect_funds, 'q08_affect_funds')
```

<p>&nbsp;</p>

```{r q09_affect_funds_comment}
show_comments(df$q09_affect_funds_comment)
```

\newpage

```{r q08_affect_funds_xtab_myrank_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q08_affect_funds', 'q01_myrank', title.y = 'Respondent Rank')
```

<p>&nbsp;</p>

```{r q08_affect_funds_xtab_mytrack_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q08_affect_funds', 'q02_mytrack', title.y = 'Respondent Track')
```

\newpage

### Q10: Preference (affect factor: opportunity cost / hiring freeze)

`r old_names$q10_affect_freeze`

```{r q10_affect_freeze_plot}
show_bar_plot(df, q10_affect_freeze, 'q10_affect_freeze')
```

<p>&nbsp;</p>

```{r q11_affect_freeze_comment}
show_comments(df$q11_affect_freeze_comment)
```

\newpage

```{r q10_affect_freeze_xtab_myrank_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q10_affect_freeze', 'q01_myrank', title.y = 'Respondent Rank')
```

<p>&nbsp;</p>

```{r q10_affect_freeze_xtab_mytrack_plot, fig.height=4, fig.width=9}
show_xtab_plot(df, 'q10_affect_freeze', 'q02_mytrack', title.y = 'Respondent Track')
```

\newpage

## Section 3

### Q12: Candidate Ranking

`r old_names$q12_ranking`

```{r q12_ranking_dplyr}
df_rank <- map_df(df$q12_ranking, xform_ranking, .id = 'id')
df_rank_sum <- df_rank %>% summarise(Sum = sum(Rank, na.rm = T)) %>% pull(Sum)
df_vote <- df_rank %>% 
  group_by(Candidate) %>% summarise(Total = sum(Rank, na.rm = T)) %>%
  arrange(Total, Candidate) %>% rownames_to_column('Rank') %>% 
  mutate(Rank = as.character(Rank)) %>% 
  add_row(Rank = 'Sum', Candidate = '', Total = df_rank_sum) %>% 
  mutate(Elected = ifelse(Total == min(Total), 'x', '')) 
df_vote <- rank_ties(df_vote)
df_vote %>% knitr::kable(align = 'llrc')
```

<p>&nbsp;</p>

```{r q12_ranking_plot}
df_rank <- df_rank %>%  
  mutate(Candidate = fct_relevel(Candidate, df_vote$Candidate[1:5]))
title <- 'Total Ranking Scores per Candidate (lower Total means higher rank)'
df_vote[1:5, ] %>% 
  mutate(Candidate = 
           factor(Candidate, 
                  ordered = TRUE, 
                  levels = levels(df_rank$Candidate))
         ) %>% 
  show_bar_plot_identity(x = Candidate, y = Total, title = title)
```

<p>&nbsp;</p>

```{r q12_ranking_heatmap}
N <- nrow(df)
title.y <- paste0('Ranking Vote (N=', N, ')')
pal <- hcl.colors(5, "RdYlGn")
pal_text <- ifelse(df_rank$Rank < 2 | df_rank$Rank > 4, 'white', 'black')
title <- 'Candidate Ranking Heatmap'
df_rank %>% mutate(id = as.integer((id))) %>% 
  ggplot(aes(fct_rev(Candidate), id, fill = Rank)) + geom_tile() + 
  geom_text(aes(label = Rank), alpha = 0.6, color = pal_text, size = 4) + 
  scale_fill_gradientn(colors = pal, transform = 'reverse') + theme_minimal() + 
  theme(axis.ticks.y = element_blank(), axis.title.y = element_blank()) + 
  ylab(title.y) + ggtitle(title) + coord_flip()
```

\newpage

```{r q13_ranking_comment}
show_comments(df$q13_ranking_comment)
```

\newpage

### Q14: Final Comments

```{r q14_final_comments}
show_comments(df$q14_final_comments)
```

```{r folder_cleanup}
# Cleanup unused (empty) folders
result <- cleanup_folders(folders)
```
