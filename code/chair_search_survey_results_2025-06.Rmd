---
title: "Chair Search Survey Results"
author: "DEOHS"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    keep_md: true
  html_document:
    keep_md: true
editor_options:
  chunk_output_type: console
---

```{r knitr_setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r package_setup}
# Load packages, installing as needed
if (!requireNamespace("pacman", quietly = TRUE)) install.packages('pacman')
pacman::p_load(here, folders, readxl, tibble, dplyr, forcats, stringr, ggplot2)
```

```{r folder_setup}
# Get the list of standard folders and create any folders which are missing
conf_file <- here('conf', 'folders.yml')
folders <- get_folders(conf_file)
result <- create_folders(folders)
```

```{r functions}
show_counts <- function(df, x) {
  df %>% group_by({{x}}) %>% summarise(Count = n()) %>% 
    arrange(desc(Count), {{x}}) %>% knitr::kable()
}

show_bar_plot <- function(df, x, title = '') {
  df %>% 
    ggplot(aes(fct_rev({{x}}))) + geom_bar() + coord_flip() + 
    geom_text(aes(label = after_stat(count)), stat = "count", hjust = 1.5, 
              color = 'white', size = 3) +
      theme_minimal() + theme(axis.title.y = element_blank()) + 
      ggtitle(label = title)
}
```

```{r get_data}
fn <- 'DEOHS Faculty Feedback Survey_ Chair Search.xlsx'
txt_fn <- str_replace(fn, '\\.xlsx$', '.txt')
csv_fn <- str_replace(fn, '\\.xlsx$', '.csv')
fp <- here(folders$data, fn)
txt_fp <- here(folders$data, txt_fn)
csv_fp <- here(folders$data, csv_fn)

level <- c("Strongly favor internal candidate", 
           "Slightly favor internal candidate", 
           "This does not affect my final preference for an internal or external candidate.", 
           "Slightly favor external candidate", 
           "Strongly favor external candidate")

label <- c("Strongly favor internal candidate", 
           "Slightly favor internal candidate", 
           "Does not affect my final preference", 
           "Slightly favor external candidate", 
           "Strongly favor external candidate")

new_names <- c('id', 'start_time', 'end_time', 'mod_time', 
               'q01_myrank', 'q02_mytrack', 'q03_pref_int_ext', 
               'q04_affect_start', 'q05_affect_start_comment',
               'q06_affect_cost', 'q07_affect_cost_comment', 
               'q08_affect_funds', 'q09_affect_funds_comment',
               'q10_affect_freeze', 'q11_affect_freeze_comment', 
               'q12_ranking', 'q13_ranking_comment', 
               'q14_final_comments')

if (( ! file.exists(csv_fp) ) | 
    (file.exists(fp) & (file.mtime(fp) > file.mtime(csv_fp))) ) {
  df <- read_xlsx(fp) %>% 
    #filter(! Email %in% c('foo@uw.edu', 'bar@uw.edu')) %>%   # Remove tests
    select(-Email, -Name)
  old_names <- names(df) %>% str_remove_all('\\r\\n.*$')
  writeLines(old_names, txt_fp)
  old_names <- as.list(old_names)
  names(old_names) <- new_names
  names(df) <- new_names
  write.csv(df, csv_fp, row.names = FALSE)
} else {
  df <- read.csv(csv_fp, stringsAsFactors = FALSE)
  old_names <- as.list(readLines(txt_fp)) %>% .[. != ''] %>% .[1:18]
  names(old_names) <- new_names
}

df <- df %>% 
  mutate(across(matches('^q\\d+_affect_[a-z]+$'), 
                ~ factor(.x, levels = level, labels = label, ordered = TRUE)))
```

## Section 1

### Q1: Rank

`r old_names$q01_myrank`

```{r q01_myrank}
show_counts(df, q01_myrank)
```

### Q2: Track

`r old_names$q02_mytrack`

```{r q02_mytrack}
show_counts(df, q02_mytrack)
```

### Q3: Preference (Internal, External, or None)

`r old_names$q03_pref_int_ext`

```{r q03_pref_int_ext}
show_counts(df, q03_pref_int_ext)
```

\newpage

## Section 2

### Q4: Preference (affect factor: delayed start)

`r old_names$q04_affect_start`

```{r q04_affect_start_plot, fig.height=2.5}
show_bar_plot(df, q04_affect_start, 'q04_affect_start')
```

### Q6: Preference (affect factor: additional cost)

`r old_names$q06_affect_cost`

```{r q06_affect_cost_plot, fig.height=2.5}
show_bar_plot(df, q06_affect_cost, 'q06_affect_cost')
```

\newpage

### Q8: Preference (affect factor: availability of funds)

`r old_names$q08_affect_funds`

```{r q08_affect_funds_plot, fig.height=2.5}
show_bar_plot(df, q08_affect_funds, 'q08_affect_funds')
```

### Q10: Preference (affect factor: opportunity cost / hiring freeze)

`r old_names$q10_affect_freeze`

```{r q10_affect_freeze_plot, fig.height=2.5}
show_bar_plot(df, q10_affect_freeze, 'q10_affect_freeze')
```

```{r folder_cleanup}
# Cleanup unused (empty) folders
result <- cleanup_folders(folders)
```
